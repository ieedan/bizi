#!/usr/bin/env bash
set -euo pipefail

APP=bizi-server
REPO="${BIZI_REPO:-ieedan/bizi}"
MUTED='\033[0;2m'
RED='\033[0;31m'
GREEN='\033[0;32m'
NC='\033[0m'

usage() {
  cat <<EOF
Bizi Server Installer

Usage: install [options]

Options:
  -h, --help              Display this help message
  -v, --version <version> Install a specific version (e.g., 0.1.0)
  -b, --binary <path>     Install from a local binary instead of downloading

Examples:
  curl -fsSL https://raw.githubusercontent.com/${REPO}/main/scripts/install | bash
  curl -fsSL https://raw.githubusercontent.com/${REPO}/main/scripts/install | bash -s -- --version 0.1.0
  ./scripts/install --binary /path/to/bizi-server

On Windows, run this script in Git Bash or WSL.
EOF
}

requested_version=${VERSION:-}
binary_path=""

while [[ $# -gt 0 ]]; do
  case "$1" in
    -h|--help)
      usage
      exit 0
      ;;
    -v|--version)
      if [[ -n "${2:-}" ]]; then
        requested_version="$2"
        shift 2
      else
        echo -e "${RED}Error: --version requires a version argument${NC}"
        exit 1
      fi
      ;;
    -b|--binary)
      if [[ -n "${2:-}" ]]; then
        binary_path="$2"
        shift 2
      else
        echo -e "${RED}Error: --binary requires a path argument${NC}"
        exit 1
      fi
      ;;
    *)
      echo -e "${RED}Unknown option: $1${NC}" >&2
      exit 1
      ;;
  esac
done

# --- OS and arch detection ---
raw_os=$(uname -s)
case "$raw_os" in
  Darwin*)  os="darwin" ;;
  Linux*)   os="linux" ;;
  MINGW*|MSYS*|CYGWIN*) os="windows" ;;
  *)
    echo -e "${RED}Unsupported OS: $raw_os${NC}"
    exit 1
    ;;
esac

arch=$(uname -m)
case "$arch" in
  aarch64|arm64) arch="arm64" ;;
  x86_64|amd64) arch="x64" ;;
  *)
    echo -e "${RED}Unsupported arch: $arch${NC}"
    exit 1
    ;;
esac

# On macOS x64 under Rosetta, prefer arm64 binary
if [ "$os" = "darwin" ] && [ "$arch" = "x64" ]; then
  rosetta=$(sysctl -n sysctl.proc_translated 2>/dev/null || echo 0)
  if [ "$rosetta" = "1" ]; then
    arch="arm64"
  fi
fi

combo="$os-$arch"
case "$combo" in
  darwin-x64|darwin-arm64|windows-x64|windows-arm64) ;;
  *)
    echo -e "${RED}Unsupported OS/arch: $os/$arch${NC}"
    exit 1
    ;;
esac

# Map to release asset filename (Rust target triple style)
case "$combo" in
  darwin-arm64)  asset_name="bizi-server-aarch64-apple-darwin" ;;
  darwin-x64)    asset_name="bizi-server-x86_64-apple-darwin" ;;
  windows-x64)   asset_name="bizi-server-x86_64-pc-windows-msvc.exe" ;;
  windows-arm64) asset_name="bizi-server-aarch64-pc-windows-msvc.exe" ;;
  *) echo -e "${RED}Unsupported: $combo${NC}"; exit 1 ;;
esac

# --- Install from local binary ---
install_from_binary() {
  local src="$1"
  if [ ! -f "$src" ]; then
    echo -e "${RED}Binary not found: $src${NC}"
    exit 1
  fi
  if [ "$os" = "darwin" ]; then
    mkdir -p "$HOME/Library/Application Support/bizi"
    BIN_DIR="/usr/local/bin"
    if [ ! -w "/usr/local/bin" ] 2>/dev/null; then
      BIN_DIR="$HOME/.local/bin"
      mkdir -p "$BIN_DIR"
    fi
    cp "$src" "$BIN_DIR/bizi-server"
    chmod 755 "$BIN_DIR/bizi-server"
    DATA_DIR="$HOME/Library/Application Support/bizi"
    PLIST="$HOME/Library/LaunchAgents/com.getbizi.server.plist"
    cat > "$PLIST" <<PLIST_XML
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
<plist version="1.0">
<dict>
  <key>Label</key>
  <string>com.getbizi.server</string>
  <key>ProgramArguments</key>
  <array>
    <string>$BIN_DIR/bizi-server</string>
    <string>--address</string>
    <string>0.0.0.0</string>
    <string>--port</string>
    <string>7436</string>
  </array>
  <key>WorkingDirectory</key>
  <string>$DATA_DIR</string>
  <key>RunAtLoad</key>
  <true/>
  <key>KeepAlive</key>
  <true/>
  <key>StandardOutPath</key>
  <string>$DATA_DIR/out.log</string>
  <key>StandardErrorPath</key>
  <string>$DATA_DIR/err.log</string>
</dict>
</plist>
PLIST_XML
    launchctl unload "$PLIST" 2>/dev/null || true
    launchctl load "$PLIST"
    echo -e "${GREEN}Installed. Server is running as a LaunchAgent (port 7436).${NC}"
    echo -e "  Binary: $BIN_DIR/bizi-server"
    echo -e "  Data:   $DATA_DIR"
  elif [ "$os" = "windows" ]; then
    DATA_DIR="${LOCALAPPDATA:-$USERPROFILE/AppData/Local}/bizi"
    BIN_DIR="$DATA_DIR/bin"
    mkdir -p "$BIN_DIR"
    cp "$src" "$BIN_DIR/bizi-server.exe"
    EXE_PATH="$BIN_DIR/bizi-server.exe"
    # Convert to Windows path for PowerShell (Git Bash: /c/Users -> C:\Users)
    to_win_path() {
      if command -v cygpath >/dev/null 2>&1; then
        cygpath -w "$1"
      else
        local p="$1"
        case "$p" in
          /[a-zA-Z]/*) p="${p:1:1}:\\${p:3}";;
        esac
        echo "$p" | sed 's|/|\\|g'
      fi
    }
    WIN_EXE=$(to_win_path "$EXE_PATH")
    WIN_DATA=$(to_win_path "$DATA_DIR")
    WIN_EXE_ESC=$(printf '%s' "$WIN_EXE" | sed "s/'/''/g")
    WIN_DATA_ESC=$(printf '%s' "$WIN_DATA" | sed "s/'/''/g")
    TASK_PS1="$(mktemp).ps1"
    cat > "$TASK_PS1" <<EOF
\$exePath = '${WIN_EXE_ESC}'
\$workingDir = '${WIN_DATA_ESC}'
\$actionArgs = "-NoProfile -WindowStyle Hidden -Command \`"Start-Process -FilePath '\$exePath' -ArgumentList '--address 0.0.0.0 --port 7436' -WorkingDirectory '\$workingDir' -WindowStyle Hidden\`""
\$action = New-ScheduledTaskAction -Execute 'powershell.exe' -Argument \$actionArgs
\$trigger = New-ScheduledTaskTrigger -AtLogOn -User \$env:USERNAME
\$principal = New-ScheduledTaskPrincipal -UserId \$env:USERNAME -LogonType Interactive
Register-ScheduledTask -TaskName 'BiziServer' -Action \$action -Trigger \$trigger -Principal \$principal -Force | Out-Null
Start-ScheduledTask -TaskName 'BiziServer' -ErrorAction SilentlyContinue
EOF
    WIN_TASK_PS1=$(to_win_path "$TASK_PS1")
    powershell.exe -NoProfile -ExecutionPolicy Bypass -File "$WIN_TASK_PS1"
    rm -f "$TASK_PS1"
    echo -e "${GREEN}Installed. Server is running and will start at logon (port 7436).${NC}"
    echo -e "  Binary: $BIN_DIR/bizi-server.exe"
    echo -e "  Data:   $DATA_DIR"
  fi
}

# --- Download and install from GitHub Release ---
# Server releases use tag prefix "server-v" (release-please component).
install_from_release() {
  if [ -z "$requested_version" ]; then
    releases_json=$(curl -sf "https://api.github.com/repos/${REPO}/releases?per_page=100") || true
    if [ -z "$releases_json" ]; then
      echo -e "${RED}Failed to fetch releases from GitHub${NC}"
      exit 1
    fi
    # Find the latest release whose tag is server-v* (list is newest first)
    tag=$(echo "$releases_json" | grep -o '"tag_name": *"[^"]*"' | sed 's/.*"tag_name": *"\([^"]*\)".*/\1/' | grep '^server-v' | head -1)
    if [ -z "$tag" ]; then
      echo -e "${RED}Failed to get latest server release (no server-v* tag found)${NC}"
      exit 1
    fi
    version="${tag#server-v}"
    url="https://github.com/${REPO}/releases/download/${tag}/${asset_name}"
  else
    version="${requested_version#v}"
    tag="server-v${version}"
    url="https://github.com/${REPO}/releases/download/${tag}/${asset_name}"
    code=$(curl -sI -o /dev/null -w "%{http_code}" "$url")
    if [ "$code" != "200" ]; then
      echo -e "${RED}Release ${tag} or asset ${asset_name} not found${NC}"
      exit 1
    fi
  fi

  echo -e "${MUTED}Downloading bizi-server v${version} (${combo})...${NC}"
  tmp_dir=$(mktemp -d)
  trap "rm -rf '$tmp_dir'" EXIT
  curl -fsSL -o "$tmp_dir/$asset_name" "$url"
  install_from_binary "$tmp_dir/$asset_name"
}

# --- Main ---
if [ -n "$binary_path" ]; then
  install_from_binary "$binary_path"
else
  install_from_release
fi
