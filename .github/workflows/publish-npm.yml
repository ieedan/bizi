name: Publish Released Packages

on:
  repository_dispatch:
    types:
      - release-please-published
  workflow_dispatch:

jobs:
  resolve-release-set:
    runs-on: ubuntu-latest
    outputs:
      publish_client: ${{ steps.resolve.outputs.publish_client }}
      publish_tui: ${{ steps.resolve.outputs.publish_tui }}
      publish_server: ${{ steps.resolve.outputs.publish_server }}
      released_paths_json: ${{ steps.resolve.outputs.released_paths_json }}
    steps:
      - name: Resolve released package paths
        id: resolve
        uses: actions/github-script@v7
        with:
          script: |
            const payloadPaths = context.payload.client_payload?.paths_released || [];
            const releasedPaths = Array.isArray(payloadPaths) ? payloadPaths : [];

            const isTuiPath = (path) =>
              path === 'apps/tui' || path.startsWith('apps/tui/packages/');

            const publishClient = releasedPaths.includes('packages/client-js');
            const publishTui = releasedPaths.some(isTuiPath);
            const publishServer = releasedPaths.includes('crates/bizi-server');

            core.setOutput('publish_client', String(publishClient));
            core.setOutput('publish_tui', String(publishTui));
            core.setOutput('publish_server', String(publishServer));
            core.setOutput('released_paths_json', JSON.stringify(releasedPaths));

  publish-server:
    needs: [resolve-release-set]
    if: ${{ needs.resolve-release-set.outputs.publish_server == 'true' }}
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write  # Required for OIDC token exchange
    steps:
      - uses: actions/checkout@v4
      - uses: rust-lang/crates-io-auth-action@v1
        id: auth

      - name: Publish server crate
        run: cargo publish -p bizi-server
        env:
          CARGO_REGISTRY_TOKEN: ${{ steps.auth.outputs.token }}

  publish-client:
    needs: [resolve-release-set]
    if: ${{ needs.resolve-release-set.outputs.publish_client == 'true' }}
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write
    steps:
      - uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
      - name: Setup Node for OIDC token exchange
        uses: actions/setup-node@v4
        with:
          node-version: lts/*
          registry-url: https://registry.npmjs.org

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build client package
        run: pnpm --filter @getbizi/client build

      - name: Publish client
        working-directory: packages/client-js
        run: pnpm publish --access public --provenance

  publish-tui:
    needs: [resolve-release-set]
    if: ${{ needs.resolve-release-set.outputs.publish_tui == 'true' }}
    runs-on: macos-latest
    permissions:
      contents: read
      id-token: write
    steps:
      - uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4

      - name: Setup Bun (for TUI compilation)
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: 1.2.13

      - name: Setup Node for OIDC token exchange
        uses: actions/setup-node@v4
        with:
          node-version: lts/*
          registry-url: https://registry.npmjs.org

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build client package
        run: pnpm --filter @getbizi/client build

      - name: Build TUI artifacts for npm packages
        run: |
          pnpm --filter bizi compile:all
          pnpm --filter bizi build:bundle

      - name: Publish TUI platform packages first
        run: |
          pnpm publish ./apps/tui/packages/bizi-darwin-arm64 --access public --provenance
          pnpm publish ./apps/tui/packages/bizi-darwin-x64 --access public --provenance
          pnpm publish ./apps/tui/packages/bizi-win32-x64 --access public --provenance
          pnpm publish ./apps/tui/packages/bizi-win32-arm64 --access public --provenance

      - name: Publish main TUI package
        run: pnpm publish ./apps/tui --access public --provenance
