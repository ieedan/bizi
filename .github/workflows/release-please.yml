name: Release Please

on:
  push:
    branches:
      - main
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write
  issues: write

jobs:
  release-please:
    runs-on: ubuntu-latest
    outputs:
      releases_created: ${{ steps.release.outputs.releases_created }}
      paths_released: ${{ steps.release.outputs.paths_released }}
    steps:
      - name: Run release-please
        id: release
        uses: googleapis/release-please-action@v4
        with:
          config-file: release-please-config.json
          manifest-file: .release-please-manifest.json

  notify-publish:
    needs: [release-please]
    if: ${{ needs.release-please.outputs.releases_created == 'true' }}
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Dispatch package publish workflow
        uses: actions/github-script@v7
        env:
          PATHS_RELEASED: ${{ needs.release-please.outputs.paths_released }}
        with:
          script: |
            const paths = [
              'crates/bizi-server',
              'packages/client-js',
              'apps/tui',
              'apps/tui/packages/bizi-darwin-arm64',
              'apps/tui/packages/bizi-darwin-x64',
              'apps/tui/packages/bizi-win32-x64',
              'apps/tui/packages/bizi-win32-arm64'
            ];
            await github.rest.repos.createDispatchEvent({
              owner: context.repo.owner,
              repo: context.repo.repo,
              event_type: 'release-please-published',
              client_payload: {
                paths_released: paths
              }
            });
